@page "/recepciones"
@using UltimateProyect.Shared.Models
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<h3>Recepciones</h3>

<div class="mb-3">
    <input @bind="filtroAlbaran"
    class="form-control"
    placeholder="Buscar por albaran..."
    @oninput="OnFiltroChanged" />
</div>
<a href="/recepciones/create" class="btn btn-success mb-3">Crear Nueva Recepción</a>

@if (cabeceras == null)
{
    <p>Cargando...</p>
}
else if (cabeceras.Length == 0)
{
    <p>No hay recepciones creadas.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Albarán</th>
                <th>Proveedor</th>
                <th>Estado</th>
                <th>Fecha Creación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var cab in AlbaranesFiltrados)
            {
                bool bloqueado = cab.Estado >= 2;
                bool bloquearEdit = cab.Estado != 2;
                bool bloquearICP = cab.Estado == 3 || cab.Estado == 4 || cab.Estado == 0;

                <tr>
                    <td>@cab.Albaran</td>
                    <td>@cab.Proveedor</td>
                    <td style="color:chocolate">@cab.Estado - @cab.DesEstado</td>
                    <td>@cab.FCreacion.ToShortDateString()</td>
                    <td>

                        <a class="btn btn-sm btn-primary @(bloquearEdit ? "disabled" : "")"
                        href="/recepciones/edit/@cab.Albaran">Editar</a>

                        <button class="btn btn-sm btn-secondary ms-1"
                        @onclick="() => Recepcionar(cab)"
                        disabled="@(bloqueado)">
                            Recepcionar
                        </button>

                        <button class="btn btn-sm btn-danger ms-1"
                        @onclick="() => Eliminar(cab.Albaran)"
                        disabled="@(bloqueado)">
                            Eliminar
                        </button>

                        <button class="btn btn-sm btn-warning ms-1"
                        @onclick="() => EnviarAICP(cab)"
                        disabled="@(bloquearICP)">
                            Enviar a ICP
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private RecepcionesCab[]? cabeceras;
    private string filtroAlbaran = "";
    private RecepcionesCab[]? AlbaranesFiltrados;

    protected override async Task OnInitializedAsync()
    {
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
        AplicarFiltro();
    }

    private void OnFiltroChanged(ChangeEventArgs e)
    {
        filtroAlbaran = e.Value?.ToString() ?? "";
        AplicarFiltro();

    }
    private void AplicarFiltro()
    {
        if (cabeceras is null) return;

        if (string.IsNullOrWhiteSpace(filtroAlbaran))
        {
            AlbaranesFiltrados = cabeceras;
        }
        else
        {
            AlbaranesFiltrados = cabeceras
                .Where(r => r.Albaran.ToString().Contains(filtroAlbaran, StringComparison.OrdinalIgnoreCase))
                .ToArray();
        }
    }

    private void Recepcionar(RecepcionesCab cab)
    {
        
        if (cab.Estado != 1)
        {
            cab.Estado = 1;
            cab.DesEstado = "SinLiberar";
            // Actualizar en el servidor
            _ = Http.PutAsJsonAsync($"api/RecepcionesCab/{cab.Albaran}", cab);
        }

        Nav.NavigateTo($"/recepcioneslin?albaran={cab.Albaran}");
    }
    private async Task EliminarCabecera(int albaran)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar el albarán {albaran}?");
        if (!confirm) return;

        await Http.DeleteAsync($"api/RecepcionesCab/{albaran}");
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
        StateHasChanged();
    }
    private async Task Eliminar(int albaran)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar la recepción {albaran}?");
        if (!confirm) return;

        await Http.DeleteAsync($"api/RecepcionesCab/{albaran}");
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
    }

    private async Task EnviarAICP(RecepcionesCab cab)
    {
        cab.Estado = 3;
        cab.DesEstado = "Enviado";
        
        await Http.PutAsJsonAsync($"api/RecepcionesCab/{cab.Albaran}", cab);

        // Refrescar la lista
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
    }
}