@page "/recepciones"
@using UltimateProyect.Shared.Models
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<div class="container py-4">
    <h1 class="mb-4">Recepciones</h1>

    <div class="mb-3">
        <input @bind="filtroAlbaran"
        class="form-control"
        placeholder="Buscar por albarán o estado..."
        @oninput="OnFiltroChanged" />
    </div>

    <a href="/recepciones/create" class="btn btn-success mb-4">
        <i class="bi bi-plus-circle me-1"></i>Crear Nueva Recepción
    </a>

    @if (cabeceras == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (AlbaranesFiltrados.Length == 0)
    {
        <div class="alert alert-info text-center" role="alert">
            <i class="bi bi-inbox me-2"></i>No hay recepciones creadas.
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var cab in AlbaranesFiltrados)
            {
                bool bloqueado = cab.Estado >= 2;
                bool bloquearEdit = cab.Estado != 2;
                bool bloquearICP = cab.Estado == 3 || cab.Estado == 4 || cab.Estado == 0;

                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Albarán <span class="text-primary"># @cab.Albaran</span></h5>
                            <span class="badge @GetEstadoBadgeClass(cab.Estado)">
                                @cab.DesEstado
                            </span>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled small text-muted">
                                <li class="mb-2">
                                    <i class="bi bi-building me-2 text-primary"></i>
                                    <strong>Proveedor:</strong> @cab.Proveedor
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-calendar-event me-2 text-muted"></i>
                                    <strong>Fecha:</strong> @cab.FCreacion.ToShortDateString()
                                </li>
                            </ul>
                        </div>
                        <div class="card-footer bg-white">
                            @if (cab.Estado < 2)
                            {
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" @onclick="() => Recepcionar(cab)" disabled="@bloqueado">
                                        <i class="bi bi-box-seam me-1"></i>Recepcionar
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="() => Eliminar(cab.Albaran)" disabled="@bloqueado">
                                        <i class="bi bi-trash me-1"></i>Eliminar
                                    </button>
                                </div>
                            }
                            else if (cab.Estado == 2)
                            {
                                <div class="d-grid gap-2">
                                    <a class="btn btn-outline-primary @(bloquearEdit ? "disabled" : "")" href="/recepciones/edit/@cab.Albaran">
                                        <i class="bi bi-pencil me-1"></i>Editar
                                    </a>
                                    <button class="btn btn-outline-warning" @onclick="() => EnviarAICP(cab)" disabled="@bloquearICP">
                                        <i class="bi bi-send me-1"></i>Enviar a ICP
                                    </button>
                                </div>
                            }
                            else if (cab.Estado > 3)
                            {
                                <div class="text-center">
                                    <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                    <p class="mt-2 mb-0 text-success">Recepción completada</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private RecepcionesCab[]? cabeceras;
    private string filtroAlbaran = "";
    private RecepcionesCab[]? AlbaranesFiltrados;

    protected override async Task OnInitializedAsync()
    {
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
        if(cabeceras is not null)
        {
            cabeceras = cabeceras.OrderByDescending(r => r.FCreacion).ToArray();
        }
        AplicarFiltro();
    }

    private void OnFiltroChanged(ChangeEventArgs e)
    {
        filtroAlbaran = e.Value?.ToString() ?? "";
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        if (cabeceras == null) return;

        AlbaranesFiltrados = string.IsNullOrWhiteSpace(filtroAlbaran)
            ? cabeceras
            : cabeceras.Where(r =>
                    r.Albaran.ToString().Contains(filtroAlbaran, StringComparison.OrdinalIgnoreCase) ||
                    r.DesEstado.Contains(filtroAlbaran, StringComparison.OrdinalIgnoreCase))
                    .OrderByDescending(r => r.FCreacion)
                .ToArray();
    }

    private async Task Recepcionar(RecepcionesCab cab)
    {
        cab.Estado = 1;
        cab.DesEstado = "Sin Liberar";
        try
        {
            await Http.PutAsJsonAsync($"api/RecepcionesCab/{cab.Albaran}", cab);

            // Actualizar la lista local
            cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
            AplicarFiltro();
            StateHasChanged();

            // Navegar a la página de líneas
            Nav.NavigateTo($"/recepcioneslin?albaran={cab.Albaran}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al iniciar la recepción: {ex.Message}");
        }
    }

    private async Task Eliminar(int albaran)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar la recepción {albaran}?");
        if (!confirm) return;

        await Http.DeleteAsync($"api/RecepcionesCab/{albaran}");
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
        AplicarFiltro();
        StateHasChanged();
    }

    private async Task EnviarAICP(RecepcionesCab cab)
    {
        cab.Estado = 3;
        cab.DesEstado = "Enviado a ICP";
        await Http.PutAsJsonAsync($"api/RecepcionesCab/{cab.Albaran}", cab);
        cabeceras = await Http.GetFromJsonAsync<RecepcionesCab[]>("api/RecepcionesCab");
        StateHasChanged();
    }

    private string GetEstadoBadgeClass(int estado)
    {
        return estado switch
        {
            0 => "bg-dark",
            1 => "bg-secondary",
            2 => "bg-info",
            3 => "bg-warning",
            4 => "bg-success",
            _ => "bg-light text-dark"
        };
    }
}