@page "/salidacab"
@using UltimateProyect.Shared.Models;
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<h3>Salidas Cab (Pedidos)</h3>
<div class="mb-3">
    <input @bind="filtroPeticion"
           class="form-control"
           placeholder="Buscar por pedido..."
           @oninput="OnFiltroChanged" />
</div>
<a href="/salidacab/create" class="btn btn-success mb-3">Crear Nueva Salida</a>

@if (salidaCab == null)
{
    <p>Cargando...</p>
}
else if (salidaCab.Length == 0)
{
    <p>No hay cabeceras creadas</p>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var scab in peticionesFiltradas)
        {
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Pedido #@scab.Peticion</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <strong>Cliente:</strong> @scab.NombreCliente<br />
                            <strong>Dirección:</strong> @scab.DireccionEntrega<br />
                            <strong>CP/Población:</strong> @scab.CodigoPostal, @scab.Poblacion<br />
                            <strong>Provincia:</strong> @scab.Provincia<br />
                            <strong>Teléfono:</strong> @scab.Telefono<br />
                            <strong>Fecha:</strong> @scab.FCreacion.ToShortDateString()<br />
                        </p>
                        <span class="badge @(scab.Estado == 1 ? "bg-info" : scab.Estado == 3 ? "bg-success" : "bg-secondary")">
                            Estado: @scab.DesEstado
                        </span>
                    </div>
                    <div class="card-footer d-flex flex-column">
                        @if (scab.Estado < 1)
                        {
                            <a href="/pedidos?peticion=@scab.Peticion" class="btn btn-sm btn-primary w-100 mb-1">Hacer Pedido</a>
                            <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => EliminarPeticion(scab.Peticion)">Eliminar</button>
                        }
                        @if (scab.Estado == 1)
                        {
                            <button class="btn btn-sm btn-success w-100 mb-1" @onclick="() => AsignarStock(scab.Peticion)">Solicitar Stock</button>
                            <a href="/edit?peticion=@scab.Peticion" class="btn btn-sm btn-warning w-100 mb-1">Editar Pedido</a>
                            <button class="btn btn-sm btn-outline-danger w-100" @onclick="() => EliminarPeticion(scab.Peticion)">Eliminar</button>

                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private VistaOrdenSalidaCab[]? salidaCab;
    private string filtroPeticion = "";
    private VistaOrdenSalidaCab[]? peticionesFiltradas;

    protected override async Task OnInitializedAsync()
    {
        salidaCab = await Http.GetFromJsonAsync<VistaOrdenSalidaCab[]>("api/ordensalidacab");
        AplicarFiltro();
    }

    private void OnFiltroChanged(ChangeEventArgs e)
    {
        filtroPeticion = e.Value?.ToString() ?? "";
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        if (salidaCab == null) return;

        if (string.IsNullOrWhiteSpace(filtroPeticion))
        {
            peticionesFiltradas = salidaCab;
        }
        else
        {
            peticionesFiltradas = salidaCab
                .Where(p => p.Peticion.ToString().Contains(filtroPeticion, StringComparison.OrdinalIgnoreCase))
                .ToArray();
        }
    }

    private void OrdenSalida(OrdenSalidaCab salida)
    {
        if (salida.Estado != 1)
        {
            salida.Estado = 1;
            _ = Http.PutAsJsonAsync($"api/ordensalidacab={salida.Peticion}", salida);
        }
    }

    private async Task EliminarPeticion(int peticion)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar la petición {peticion}?");
        if (!confirm) return;

        await Http.DeleteAsync($"api/ordensalidacab/{peticion}");
        salidaCab = await Http.GetFromJsonAsync<VistaOrdenSalidaCab[]>("api/ordensalidacab");
        StateHasChanged();
    }

    private async Task AsignarStock(int peticion)
    {
        try
        {
            var response = await Http.PostAsync($"api/RecepcionesLin/asignar-stock/{peticion}", null);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Stock asignado correctamente.");
                salidaCab = await Http.GetFromJsonAsync<VistaOrdenSalidaCab[]>("api/ordensalidacab");
                AplicarFiltro();
                StateHasChanged();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Error al asignar stock.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }
}
