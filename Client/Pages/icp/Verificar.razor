@page "/icp/verificar/{Peticion:int}"
@using UltimateProyect.Shared.Models
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<h3>Picking de - Petición @Peticion</h3>

@if (verificacion == null)
{
    <p>Cargando datos de la verificación...</p>
}
else
{
    <div class="card mb-3">
        <div class="card-header">
            Cliente: @verificacion.NombreCliente
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Palet</th>
                <th>Ubicacion</th>
                <th>Referencia</th>
                <th>Artículo</th>
                <th>Cantidad</th>
                <th>Números de Serie</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var linea in verificacion.Lineas)
            {
                @foreach (var palet in linea.PaletsDisponibles)
                {
                    var claveUnica = $"{palet.Palet}";
                    <tr>
                        <td>@palet.Palet</td>
                        <td>@palet.Ubicacion</td>
                        <td>@linea.Referencia</td>
                        <td>@linea.DesReferencia</td>
                        <td>@palet.Cantidad</td>
                        @if (linea.RequiereNSerie == true)
                        {
                            <td>
                                @if (linea.LongNSerie.HasValue)
                                {
                                    <small class="text-muted mb-2 d-block">Longitud esperada: @linea.LongNSerie caracteres</small>
                                }
                                @if (palet.Cantidad > 0)
                                {
                                    <div class="mb-2">
                                        <label>NSerie (@palet.Cantidad):</label>
                                        <textarea @oninput="(e) => nsPorPalet[claveUnica] = e.Value?.ToString() ?? string.Empty"
                                                  class="form-control"
                                                  rows="2">@nsPorPalet.GetValueOrDefault(claveUnica, "")</textarea>
                                    </div>
                                }
                            </td>
                        }
                        else
                        {
                            <td>No requiere NSerie</td>
                        }
                    </tr>
                }
            }
        </tbody>
    </table>

    <button class="btn btn-success" @onclick="ConfirmarVerificacion">Confirmar Verificación</button>
    <button class="btn btn-secondary" @onclick="NavegarA_Icp">Volver</button>
}

@code {
    [Parameter] public int Peticion { get; set; }
    private VerificacionIcpDto? verificacion;
    private Dictionary<string, string> nsPorPalet = new();

    private void NavegarA_Icp() => Nav.NavigateTo("/icp/picking");

    protected override async Task OnInitializedAsync()
    {
        verificacion = await Http.GetFromJsonAsync<VerificacionIcpDto>($"api/icp/verificar/{Peticion}");
    }

    private async Task ConfirmarVerificacion()
    {
        if (verificacion == null) return;

        foreach (var linea in verificacion.Lineas)
        {
            var nsTotales = new List<string>();
            foreach (var palet in linea.PaletsDisponibles)
            {
                var clave = $"{palet.Palet}";
                var valor = nsPorPalet.GetValueOrDefault(clave, "");
                var lista = valor.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
                nsTotales.AddRange(lista);
            }

            if (linea.RequiereNSerie == true)
            {
                if (nsTotales.Count != linea.Cantidad)
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"Debe ingresar exactamente {linea.Cantidad} números de serie.");
                    return;
                }

                var todosValidos = linea.NumerosSerieValidos;
                var invalidos = nsTotales.Except(todosValidos, StringComparer.OrdinalIgnoreCase).ToList();
                if (invalidos.Any())
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"Números de serie inválidos: {string.Join(", ", invalidos)}");
                    return;
                }
            }

            linea.NumerosSerie = nsTotales;
        }

        try
        {
            var response = await Http.PostAsJsonAsync("api/icp/confirmar-verificacion", verificacion);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Verificación completada correctamente.");
                Nav.NavigateTo("/icp");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync("alert", $"Error: {response.StatusCode} - {error}");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }
}