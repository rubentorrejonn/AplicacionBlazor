@page "/moverpalet/{PaletId:int}"
@using UltimateProyect.Shared.Models
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<h3>Mover Palet @PaletId</h3>

@if (palet == null)
{
    <p>Cargando palet...</p>
}
else if (ubicaciones == null)
{
    <p>Cargando ubicaciones...</p>
}
else
{
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Datos del Palet</h5>
            <p class="card-text"><strong>ID:</strong> @palet.Palet</p>
            <p class="card-text"><strong>Referencia:</strong> @palet.Referencia</p>
            <p class="card-text"><strong>Cantidad:</strong> @palet.Cantidad</p>
            <p class="card-text"><strong>Ubicación Actual:</strong> @palet.Ubicacion</p>
        </div>
    </div>

    <div class="mt-3">
        <label for="ubicacionSelect">Seleccionar nueva ubicación:</label>
        <InputSelect id="ubicacionSelect" @bind-Value="nuevaUbicacionSeleccionada" class="form-control">
            <option value="">-- Seleccione una ubicación --</option>
            @foreach (var ubi in ubicaciones)
            {
                <option value="@ubi.Ubicacion">@ubi.Ubicacion - @ubi.DesUbicacion</option>
            }
        </InputSelect>
    </div>

    <button class="btn btn-success mt-3" @onclick="MoverPalet" disabled="@(string.IsNullOrEmpty(nuevaUbicacionSeleccionada))">Mover Palet</button>
    <button class="btn btn-secondary mt-3 ms-2" @onclick="Cancelar">Cancelar</button>
}

@code {
    [Parameter] public int PaletId { get; set; }
    private Palets? palet;
    private Ubicaciones[]? ubicaciones;
    private string nuevaUbicacionSeleccionada = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        palet = await Http.GetFromJsonAsync<Palets>($"api/palets/{PaletId}");
        ubicaciones = await Http.GetFromJsonAsync<Ubicaciones[]>("api/palets/activas");
    }

    private async Task MoverPalet()
    {
        if (string.IsNullOrEmpty(nuevaUbicacionSeleccionada) || palet == null) return;

        try
        {
            var request = new MoverPaletRequestDto
                {
                    NuevaUbicacion = nuevaUbicacionSeleccionada
                };

            var response = await Http.PutAsJsonAsync($"api/palets/{PaletId}/mover", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<object>();
                await JSRuntime.InvokeVoidAsync("alert", result?.ToString() ?? "Palet movido correctamente.");
                Nav.NavigateTo("/moverpalets");
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<LoginResultDto>();
                await JSRuntime.InvokeVoidAsync("alert", error?.Message ?? "Error al mover el palet.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void Cancelar() => Nav.NavigateTo("/moverpalets");
}