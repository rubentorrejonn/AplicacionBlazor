@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<CascadingAuthenticationState>
    <div class="page d-flex flex-column min-vh-100">
        <nav class="navbar navbar-expand-lg navbar-light bg-secondary bg-opacity-25 shadow-sm">
            <div class="container-fluid">
                <div class="navbar-brand">
                    <NavLink class="nav-link text-dark p-0" href="" Match="NavLinkMatch.All">
                        <span class="oi oi-home me-1"></span> Home
                    </NavLink>
                </div>

                <button class="navbar-toggler" type="button" @onclick="ToggleMenu">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse @(menuAbierto ? "show" : "")" id="mainNavbar">
                    <div class="navbar-nav">
                        <AuthorizeView Policy="Cliente">
                            <NavLink class="nav-link" href="refpage">Referencias</NavLink>
                            <NavLink class="nav-link" href="recepciones">Recepciones</NavLink>
                            <NavLink class="nav-link" href="salidacab">Pedidos</NavLink>
                            <NavLink class="nav-link" href="log">Visor</NavLink>
                        </AuthorizeView>
                        <AuthorizeView Policy="ICP">
                            <NavLink class="nav-link" href="icp">ICP</NavLink>
                            <NavLink class="nav-link" href="moverpalets">Mover Palets</NavLink>
                            <NavLink class="nav-link" href="icp/picking">Picking</NavLink>
                        </AuthorizeView>
                    </div>
                </div>

                <div class="d-flex align-items-center ms-auto">
                    <AuthorizeView>
                        <Authorized>
                            <span class="badge bg-success bg-opacity-25 text-success rounded-pill px-3 py-1 me-2">
                                @context.User.Identity.Name
                            </span>
                            <button class="btn btn-sm btn-outline-danger" @onclick="Logout">Salir</button>
                        </Authorized>
                    </AuthorizeView>
                </div>
            </div>
        </nav>

        <main class="flex-grow-1">
            <article class="container py-3">
                @Body
            </article>
        </main>
    </div>
</CascadingAuthenticationState>

@code {
    private bool menuAbierto = false;

    private void ToggleMenu() => menuAbierto = !menuAbierto;

    private async Task Logout()
    {
        await Http.PostAsync("api/auth/logout", null);
        await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/'");
    }

    private async Task ReloadPage()
    {
        await JSRuntime.InvokeVoidAsync("location.reload");
    }
}